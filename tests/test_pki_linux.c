/*
 * test_pki_linux.c — Tests for Linux PKI/certificate functions (pki.c)
 *
 * Tests the OpenSSL-based implementation of:
 *   WinPKIErrorString, ValidateOpensslSignature, GetSignatureName,
 *   GetSignatureTimeStamp, GetIssuerCertificateInfo, ValidateSignature,
 *   ParseSKUSiPolicy
 *
 * Linux-only.
 */
#ifndef __linux__
#include <stdio.h>
int main(void) { printf("SKIP: Linux-only test\n"); return 0; }
#else

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <stdarg.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/stat.h>

/* ---- test framework ---- */
#include "framework.h"

/* ---- compat layer ---- */
#include "windows.h"
#include "commctrl.h"

/* ---- rufus headers ---- */
#include "rufus.h"
#include "resource.h"
#include "missing.h"

/* ================================================================
 * Minimal globals required by linux/pki.c
 * ================================================================ */

HWND hMainDialog   = NULL;
HWND hDeviceList   = NULL;
HWND hProgress     = NULL;
HWND hStatus       = NULL;
HWND hInfo         = NULL;
HWND hLog          = NULL;
HWND hCapacity     = NULL;

BOOL op_in_progress        = FALSE;
BOOL enable_HDDs           = FALSE;
BOOL enable_VHDs           = TRUE;
BOOL right_to_left_mode    = FALSE;
BOOL large_drive           = FALSE;
BOOL write_as_esp          = FALSE;
BOOL write_as_image        = FALSE;
BOOL lock_drive            = FALSE;
BOOL zero_drive            = FALSE;
BOOL fast_zeroing          = FALSE;
BOOL force_large_fat32     = FALSE;
BOOL enable_ntfs_compression = FALSE;
BOOL enable_file_indexing  = FALSE;

DWORD ErrorStatus          = 0;
DWORD LastWriteError       = 0;
DWORD MainThreadId         = 0;
DWORD DownloadStatus       = 0;

int fs_type                = 0;
int boot_type              = 0;
int partition_type         = 0;
int target_type            = 0;
int dialog_showing         = 0;
int force_update           = 0;

RUFUS_UPDATE update        = {{0}, {0}, NULL, NULL};
windows_version_t WindowsVersion = {0};
BOOL en_msg_mode           = FALSE;

/* Minimal stubs */
void uprintf(const char *fmt, ...) { (void)fmt; }
void uprintfs(const char *s) { (void)s; }
char* lmprintf(uint32_t msg_id, ...) { (void)msg_id; return ""; }
int NotificationEx(int type, const char* dont_display_setting,
                   const notification_info* more_info,
                   const char* title, const char* format, ...)
    { (void)type; (void)dont_display_setting; (void)more_info; (void)title; (void)format; return 0; }

/* Stubs for functions called by GetSignatureCertInfo */
uint32_t read_file(const char *path, uint8_t **buf)
{
    struct stat st;
    if (!path || !buf) { if (buf) *buf = NULL; return 0; }
    if (stat(path, &st) != 0 || st.st_size == 0) { *buf = NULL; return 0; }
    FILE *f = fopen(path, "rb");
    if (!f) { *buf = NULL; return 0; }
    *buf = malloc((size_t)st.st_size);
    if (!*buf) { fclose(f); return 0; }
    uint32_t n = (uint32_t)fread(*buf, 1, (size_t)st.st_size, f);
    fclose(f);
    if (n == 0) { free(*buf); *buf = NULL; }
    return n;
}
uint8_t *GetPeSignatureData(uint8_t *buf) { (void)buf; return NULL; }

/* ================================================================
 * Function declarations (from linux/pki.c)
 * ================================================================ */
extern const char* WinPKIErrorString(void);
extern char* GetSignatureName(const char* path, const char* country_code,
                              uint8_t* thumbprint, BOOL bSilent);
extern int   GetIssuerCertificateInfo(uint8_t* cert, cert_info_t* info);
extern int   GetSignatureCertInfo(const char* path, cert_info_t* info);
extern uint64_t GetSignatureTimeStamp(const char* path);
extern LONG  ValidateSignature(HWND hDlg, const char* path);
extern BOOL  ValidateOpensslSignature(BYTE* buf, DWORD buflen, BYTE* sig, DWORD siglen);
extern BOOL  ParseSKUSiPolicy(void);
extern void  pki_set_ca_bundle_path(const char* path);

/* ================================================================
 * Tests: WinPKIErrorString
 * ================================================================ */

TEST(win_pki_error_string_not_null)
{
    const char* s = WinPKIErrorString();
    CHECK_MSG(s != NULL, "WinPKIErrorString() returned NULL");
}

TEST(win_pki_error_string_no_error)
{
    const char* s = WinPKIErrorString();
    CHECK_MSG(s != NULL && s[0] != '\0', "WinPKIErrorString() returned empty string");
}

/* ================================================================
 * Tests: ValidateOpensslSignature — parameter validation
 * ================================================================ */

TEST(validate_openssl_sig_null_buf)
{
    uint8_t sig[RSA_SIGNATURE_SIZE] = {0};
    BOOL r = ValidateOpensslSignature(NULL, 8, sig, RSA_SIGNATURE_SIZE);
    CHECK_MSG(r == FALSE, "NULL buf should return FALSE");
}

TEST(validate_openssl_sig_null_sig)
{
    uint8_t buf[8] = {0};
    BOOL r = ValidateOpensslSignature(buf, 8, NULL, RSA_SIGNATURE_SIZE);
    CHECK_MSG(r == FALSE, "NULL sig should return FALSE");
}

TEST(validate_openssl_sig_zero_len)
{
    uint8_t buf[8] = {0};
    uint8_t sig[RSA_SIGNATURE_SIZE] = {0};
    BOOL r = ValidateOpensslSignature(buf, 0, sig, RSA_SIGNATURE_SIZE);
    CHECK_MSG(r == FALSE, "zero buflen should return FALSE");
}

TEST(validate_openssl_sig_wrong_sig_size)
{
    uint8_t buf[8] = {0};
    uint8_t sig[RSA_SIGNATURE_SIZE - 1] = {0};
    BOOL r = ValidateOpensslSignature(buf, 8, sig, RSA_SIGNATURE_SIZE - 1);
    CHECK_MSG(r == FALSE, "wrong siglen should return FALSE");
}

TEST(validate_openssl_sig_bad_signature)
{
    /* Random bytes for both buffer and signature — should fail RSA verification */
    uint8_t buf[32];
    uint8_t sig[RSA_SIGNATURE_SIZE];
    size_t i;
    for (i = 0; i < sizeof(buf); i++) buf[i] = (uint8_t)(i ^ 0xA5);
    for (i = 0; i < sizeof(sig); i++) sig[i] = (uint8_t)(i * 3 + 7);
    BOOL r = ValidateOpensslSignature(buf, sizeof(buf), sig, RSA_SIGNATURE_SIZE);
    CHECK_MSG(r == FALSE, "random signature should not verify");
}

/* ================================================================
 * Tests: GetSignatureName
 * ================================================================ */

TEST(get_signature_name_null_path_ok)
{
    /* NULL path → try current binary (unsigned on Linux dev build) → NULL or string */
    char* name = GetSignatureName(NULL, NULL, NULL, TRUE);
    /* Just verify it doesn't crash; result may be NULL for unsigned binaries */
    (void)name;
    CHECK(1);
}

TEST(get_signature_name_nonexistent)
{
    char* name = GetSignatureName("/nonexistent_file_for_rufus_test.exe",
                                  NULL, NULL, TRUE);
    CHECK_MSG(name == NULL, "nonexistent file should return NULL");
}

TEST(get_signature_name_not_pe)
{
    /* Create a temp text file that is definitely not a PE */
    char tmppath[] = "/tmp/rufus_pki_test_XXXXXX";
    int fd = mkstemp(tmppath);
    CHECK_MSG(fd >= 0, "failed to create temp file");
    const char* txt = "This is not a PE file.\n";
    write(fd, txt, strlen(txt));
    close(fd);

    char* name = GetSignatureName(tmppath, NULL, NULL, TRUE);
    unlink(tmppath);
    CHECK_MSG(name == NULL, "non-PE file should return NULL");
}

/* ================================================================
 * Tests: GetSignatureTimeStamp
 * ================================================================ */

TEST(get_signature_timestamp_null)
{
    /* NULL path → try current binary → 0 on unsigned binary */
    uint64_t ts = GetSignatureTimeStamp(NULL);
    /* Unsigned dev binary → 0; we just verify no crash */
    (void)ts;
    CHECK(1);
}

TEST(get_signature_timestamp_nonexistent)
{
    uint64_t ts = GetSignatureTimeStamp("/nonexistent_file_for_rufus_test.exe");
    CHECK_MSG(ts == 0, "nonexistent file should return 0");
}

TEST(get_signature_timestamp_not_pe)
{
    char tmppath[] = "/tmp/rufus_pki_ts_test_XXXXXX";
    int fd = mkstemp(tmppath);
    CHECK_MSG(fd >= 0, "failed to create temp file");
    const char* txt = "not a PE\n";
    write(fd, txt, strlen(txt));
    close(fd);

    uint64_t ts = GetSignatureTimeStamp(tmppath);
    unlink(tmppath);
    CHECK_MSG(ts == 0, "non-PE file should return 0 timestamp");
}

/* ================================================================
 * Tests: GetIssuerCertificateInfo
 * ================================================================ */

TEST(get_issuer_cert_info_null_cert)
{
    cert_info_t info;
    memset(&info, 0, sizeof(info));
    int r = GetIssuerCertificateInfo(NULL, &info);
    /* NULL cert with valid info → 0 (unsigned/empty) */
    CHECK_MSG(r == 0 || r == -1, "NULL cert should return 0 or -1");
}

TEST(get_issuer_cert_info_null_info)
{
    /* Non-NULL cert pointer with garbage data, but info is NULL → -1 (error) */
    uint8_t fake_cert[16] = {0};
    int r = GetIssuerCertificateInfo(fake_cert, NULL);
    CHECK_MSG(r == -1, "NULL info should return -1");
}

TEST(get_issuer_cert_info_zero_length)
{
    /* WIN_CERTIFICATE with dwLength == 0 → 0 (no cert) */
    uint8_t fake_cert[16] = {0};  /* dwLength = 0 */
    cert_info_t info;
    memset(&info, 0, sizeof(info));
    int r = GetIssuerCertificateInfo(fake_cert, &info);
    CHECK_MSG(r == 0 || r == -1, "zero-length cert should return 0 or -1");
}

/* ================================================================
 * Chain trust test fixtures
 *
 * Generated with:
 *   openssl genrsa -out ca.key 2048
 *   openssl req -new -x509 -key ca.key -out ca.crt -subj "/CN=RufusTestCA/O=RufusTest"
 *   openssl genrsa -out signer.key 2048
 *   openssl req -new -key signer.key -out signer.csr -subj "/CN=RufusSigner/O=RufusTest"
 *   openssl x509 -req -in signer.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out signer.crt
 *   echo -n "dummy" | openssl cms -sign -signer signer.crt -inkey signer.key \
 *     -certfile ca.crt -outform DER -nodetach -out chain_signed.p7
 *   echo -n "dummy" | openssl cms -sign -signer self.crt -inkey self.key \
 *     -outform DER -nodetach -out self_signed.p7
 *
 * chain_signed_p7: RufusSigner cert signed by RufusTestCA (chain of 2)
 * self_signed_p7:  SelfSigned cert (self-signed, chain of 1)
 * test_ca_pem:     RufusTestCA in PEM format (trust anchor for tests)
 * ================================================================ */

/* WIN_CERTIFICATE header: dwLength(4) + wRevision(2) + wCertType(2) + data */
static uint8_t *make_win_cert(const uint8_t *pkcs7, uint32_t pkcs7_len)
{
    uint32_t total = pkcs7_len + 8;
    uint8_t *buf = malloc(total);
    if (!buf) return NULL;
    /* dwLength (LE) */
    buf[0] = total & 0xff; buf[1] = (total >> 8) & 0xff;
    buf[2] = (total >> 16) & 0xff; buf[3] = (total >> 24) & 0xff;
    /* wRevision = 0x0200 (LE) */
    buf[4] = 0x00; buf[5] = 0x02;
    /* wCertificateType = 0x0002 (LE) */
    buf[6] = 0x02; buf[7] = 0x00;
    memcpy(buf + 8, pkcs7, pkcs7_len);
    return buf;
}

/* Write a PEM string to a temp file, return path (caller must free + unlink) */
static char *write_temp_pem(const char *pem)
{
    char *path = strdup("/tmp/rufus_test_ca_XXXXXX.pem");
    if (!path) return NULL;
    int fd = mkstemps(path, 4);
    if (fd < 0) { free(path); return NULL; }
    write(fd, pem, strlen(pem));
    close(fd);
    return path;
}

/* chain_signed.p7 DER — signer=RufusSigner, CA=RufusTestCA */
static const uint8_t chain_signed_p7[] = {
  0x30, 0x82, 0x08, 0xf6, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
  0x01, 0x07, 0x02, 0xa0, 0x82, 0x08, 0xe7, 0x30, 0x82, 0x08, 0xe3, 0x02,
  0x01, 0x01, 0x31, 0x0d, 0x30, 0x0b, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
  0x65, 0x03, 0x04, 0x02, 0x01, 0x30, 0x14, 0x06, 0x09, 0x2a, 0x86, 0x48,
  0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x07, 0x04, 0x05, 0x64, 0x75,
  0x6d, 0x6d, 0x79, 0xa0, 0x82, 0x06, 0x61, 0x30, 0x82, 0x03, 0x24, 0x30,
  0x82, 0x02, 0x0c, 0xa0, 0x03, 0x02, 0x01, 0x02, 0x02, 0x14, 0x44, 0x7f,
  0xab, 0xc2, 0xc7, 0x6c, 0x31, 0x08, 0x11, 0x24, 0x89, 0xc3, 0xd2, 0x97,
  0x63, 0xb3, 0xb2, 0x74, 0x81, 0xc4, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
  0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x0b, 0x05, 0x00, 0x30, 0x2a, 0x31,
  0x14, 0x30, 0x12, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x0b, 0x52, 0x75,
  0x66, 0x75, 0x73, 0x54, 0x65, 0x73, 0x74, 0x43, 0x41, 0x31, 0x12, 0x30,
  0x10, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x09, 0x52, 0x75, 0x66, 0x75,
  0x73, 0x54, 0x65, 0x73, 0x74, 0x30, 0x1e, 0x17, 0x0d, 0x32, 0x36, 0x30,
  0x33, 0x30, 0x32, 0x30, 0x31, 0x34, 0x31, 0x32, 0x37, 0x5a, 0x17, 0x0d,
  0x33, 0x36, 0x30, 0x32, 0x32, 0x38, 0x30, 0x31, 0x34, 0x31, 0x32, 0x37,
  0x5a, 0x30, 0x2a, 0x31, 0x14, 0x30, 0x12, 0x06, 0x03, 0x55, 0x04, 0x03,
  0x0c, 0x0b, 0x52, 0x75, 0x66, 0x75, 0x73, 0x53, 0x69, 0x67, 0x6e, 0x65,
  0x72, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x09,
  0x52, 0x75, 0x66, 0x75, 0x73, 0x54, 0x65, 0x73, 0x74, 0x30, 0x82, 0x01,
  0x22, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
  0x01, 0x01, 0x05, 0x00, 0x03, 0x82, 0x01, 0x0f, 0x00, 0x30, 0x82, 0x01,
  0x0a, 0x02, 0x82, 0x01, 0x01, 0x00, 0xe2, 0x66, 0x50, 0xa0, 0x0c, 0xe4,
  0x5b, 0x54, 0x8f, 0xc6, 0xa1, 0x61, 0xb7, 0x95, 0x29, 0x96, 0xa3, 0xd6,
  0xf4, 0x80, 0xce, 0x33, 0x30, 0x05, 0x81, 0x43, 0x96, 0xfe, 0xc2, 0x11,
  0xea, 0x9b, 0x88, 0x96, 0x75, 0xe4, 0x44, 0xc5, 0x59, 0xb3, 0x73, 0x88,
  0x54, 0xf7, 0xd1, 0xc6, 0x31, 0xc8, 0xc8, 0xda, 0x3d, 0xe1, 0xe5, 0xf5,
  0x2f, 0x31, 0x9d, 0xb4, 0xca, 0xd6, 0x15, 0x31, 0xc9, 0xad, 0x5f, 0xa7,
  0x69, 0x57, 0x80, 0x1a, 0x35, 0x73, 0xd0, 0xc4, 0x5d, 0xbd, 0xaa, 0x55,
  0x79, 0x59, 0x84, 0x6c, 0x04, 0xe3, 0x6e, 0x8d, 0x52, 0xcb, 0x7a, 0x1f,
  0x1f, 0xc5, 0x72, 0x7f, 0x2d, 0x6c, 0x9f, 0x9f, 0x8b, 0xc5, 0xa1, 0x3a,
  0xb5, 0x4a, 0xd9, 0x47, 0x71, 0xa8, 0xdb, 0x7a, 0xba, 0xfd, 0x1d, 0x79,
  0xc9, 0xea, 0x29, 0xcc, 0x6a, 0x91, 0x84, 0x66, 0x2c, 0x67, 0x9a, 0x32,
  0x51, 0xb7, 0x97, 0xea, 0x08, 0x65, 0x2d, 0x70, 0xe9, 0xcf, 0x8c, 0x97,
  0xa0, 0x9e, 0xdc, 0xb2, 0x35, 0x64, 0x3b, 0xb4, 0x99, 0xec, 0xef, 0xed,
  0xf2, 0xf5, 0x88, 0xd3, 0x68, 0xe0, 0xdd, 0x1b, 0xc0, 0x9e, 0x89, 0x01,
  0x1c, 0x6e, 0xd4, 0x25, 0x50, 0xba, 0x24, 0xe4, 0x22, 0x12, 0x44, 0x5a,
  0xd5, 0x67, 0x0a, 0x1c, 0xc9, 0xc4, 0xbe, 0x3c, 0xb9, 0xb2, 0x2f, 0xf0,
  0x1d, 0xfd, 0x75, 0xba, 0x3a, 0xf0, 0x76, 0x39, 0x99, 0x79, 0x2e, 0x77,
  0x9c, 0x44, 0x5f, 0x67, 0xfc, 0xd9, 0x3e, 0x9a, 0xd8, 0x5b, 0x99, 0x3c,
  0x88, 0x07, 0xd0, 0xf6, 0x79, 0xe3, 0xa6, 0xe9, 0x2e, 0xb8, 0xe6, 0x51,
  0x58, 0x7e, 0x24, 0xff, 0x6b, 0x80, 0xd0, 0x6a, 0x58, 0x39, 0x4f, 0x54,
  0x22, 0x1a, 0xdf, 0x5c, 0x1c, 0x6b, 0x15, 0x90, 0x2e, 0x91, 0xfc, 0x33,
  0x55, 0x73, 0x2f, 0x1f, 0x91, 0x0c, 0xd3, 0xd9, 0x78, 0xbd, 0x02, 0x03,
  0x01, 0x00, 0x01, 0xa3, 0x42, 0x30, 0x40, 0x30, 0x1d, 0x06, 0x03, 0x55,
  0x1d, 0x0e, 0x04, 0x16, 0x04, 0x14, 0xe1, 0xba, 0xb9, 0x80, 0x28, 0xc4,
  0x57, 0xb2, 0x00, 0xf0, 0x07, 0xc1, 0x5a, 0x4b, 0xdb, 0x5b, 0x37, 0x11,
  0x3e, 0x45, 0x30, 0x1f, 0x06, 0x03, 0x55, 0x1d, 0x23, 0x04, 0x18, 0x30,
  0x16, 0x80, 0x14, 0xe2, 0x69, 0xea, 0x21, 0xe2, 0xa6, 0x1e, 0xb2, 0x69,
  0xe8, 0x7a, 0xed, 0x7d, 0x5d, 0xc4, 0xc4, 0x0c, 0x87, 0x80, 0xf3, 0x30,
  0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x0b,
  0x05, 0x00, 0x03, 0x82, 0x01, 0x01, 0x00, 0x96, 0xd4, 0x7b, 0xf8, 0x22,
  0x92, 0xca, 0xfa, 0xf0, 0xb4, 0x95, 0xea, 0x0e, 0x27, 0xab, 0x8c, 0x9b,
  0xe9, 0xf0, 0x6e, 0xf3, 0xc2, 0x94, 0xc9, 0xc3, 0x3e, 0xe5, 0x0c, 0x0c,
  0xd4, 0x8a, 0xed, 0x86, 0xca, 0x95, 0xab, 0x5b, 0x05, 0x09, 0xf1, 0xac,
  0xd5, 0x63, 0x45, 0x92, 0x4a, 0x58, 0xfe, 0x4f, 0x07, 0x7f, 0xb5, 0xee,
  0xaf, 0x88, 0x21, 0xcd, 0x6f, 0xfc, 0x54, 0xd6, 0xfd, 0xce, 0x74, 0x83,
  0x02, 0x6f, 0x49, 0xaf, 0x3a, 0xef, 0xb2, 0xfc, 0x3c, 0x4a, 0x7b, 0xc3,
  0xa7, 0x2a, 0x04, 0x21, 0x35, 0x46, 0x2b, 0xdf, 0xe8, 0x84, 0x60, 0x64,
  0x90, 0x3d, 0x38, 0xc4, 0x82, 0x19, 0x27, 0xbf, 0x7c, 0x3b, 0x35, 0xfb,
  0x12, 0xa5, 0x59, 0xa8, 0x45, 0x39, 0x0c, 0x6f, 0x43, 0x62, 0x45, 0x38,
  0x94, 0xab, 0xb9, 0x76, 0x17, 0x12, 0x53, 0x92, 0x72, 0xd2, 0xb6, 0x17,
  0x13, 0x40, 0xb0, 0xca, 0x69, 0x71, 0x68, 0xe7, 0xf3, 0x33, 0x82, 0xa1,
  0xeb, 0x14, 0xa2, 0x41, 0x7d, 0x8a, 0xbb, 0x0e, 0x03, 0x1f, 0xb4, 0x5d,
  0xbb, 0x29, 0xf6, 0xe8, 0x1e, 0xe4, 0xdc, 0x1e, 0x01, 0x32, 0x37, 0x1f,
  0xf1, 0x30, 0x56, 0x7b, 0x42, 0x33, 0x2e, 0x32, 0xb9, 0xa7, 0x69, 0x56,
  0x0f, 0x86, 0x0c, 0x60, 0x2b, 0x0c, 0xf6, 0xd2, 0x73, 0x62, 0x59, 0xd3,
  0x1b, 0xba, 0xcd, 0x8d, 0x20, 0xf2, 0xe2, 0x43, 0x63, 0xb8, 0x9f, 0x0d,
  0xd7, 0x96, 0xb3, 0x14, 0x88, 0x58, 0x08, 0x35, 0x8c, 0x9d, 0xc7, 0x7a,
  0x6f, 0xea, 0x30, 0x20, 0x4d, 0xf4, 0x12, 0x78, 0xb4, 0xdc, 0x69, 0xcb,
  0xfe, 0x71, 0x71, 0x43, 0x07, 0xfe, 0x99, 0x23, 0x9e, 0x97, 0x05, 0x80,
  0xc8, 0xa7, 0x72, 0x6b, 0xcf, 0xc7, 0xc9, 0x0e, 0x14, 0xd1, 0x56, 0x2e,
  0x4a, 0xf7, 0xad, 0x9b, 0x2d, 0x82, 0x8e, 0x6b, 0x19, 0x1b, 0xb8, 0x30,
  0x82, 0x03, 0x35, 0x30, 0x82, 0x02, 0x1d, 0xa0, 0x03, 0x02, 0x01, 0x02,
  0x02, 0x14, 0x10, 0x23, 0x76, 0x2c, 0xb6, 0x53, 0x10, 0x22, 0x29, 0x89,
  0x0d, 0xa4, 0x15, 0x84, 0xc7, 0x72, 0x66, 0xf3, 0xb7, 0x6c, 0x30, 0x0d,
  0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x0b, 0x05,
  0x00, 0x30, 0x2a, 0x31, 0x14, 0x30, 0x12, 0x06, 0x03, 0x55, 0x04, 0x03,
  0x0c, 0x0b, 0x52, 0x75, 0x66, 0x75, 0x73, 0x54, 0x65, 0x73, 0x74, 0x43,
  0x41, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x09,
  0x52, 0x75, 0x66, 0x75, 0x73, 0x54, 0x65, 0x73, 0x74, 0x30, 0x1e, 0x17,
  0x0d, 0x32, 0x36, 0x30, 0x33, 0x30, 0x32, 0x30, 0x31, 0x34, 0x31, 0x32,
  0x37, 0x5a, 0x17, 0x0d, 0x33, 0x36, 0x30, 0x32, 0x32, 0x38, 0x30, 0x31,
  0x34, 0x31, 0x32, 0x37, 0x5a, 0x30, 0x2a, 0x31, 0x14, 0x30, 0x12, 0x06,
  0x03, 0x55, 0x04, 0x03, 0x0c, 0x0b, 0x52, 0x75, 0x66, 0x75, 0x73, 0x54,
  0x65, 0x73, 0x74, 0x43, 0x41, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55,
  0x04, 0x0a, 0x0c, 0x09, 0x52, 0x75, 0x66, 0x75, 0x73, 0x54, 0x65, 0x73,
  0x74, 0x30, 0x82, 0x01, 0x22, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48,
  0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x03, 0x82, 0x01, 0x0f,
  0x00, 0x30, 0x82, 0x01, 0x0a, 0x02, 0x82, 0x01, 0x01, 0x00, 0xbd, 0xf9,
  0xef, 0xf4, 0xbb, 0x69, 0xd2, 0x9e, 0x40, 0xa4, 0x73, 0x42, 0x5f, 0x29,
  0x56, 0xef, 0x82, 0xf8, 0x56, 0x01, 0x41, 0x7a, 0x2a, 0x34, 0xcc, 0xdb,
  0xaf, 0x36, 0xc5, 0x43, 0x91, 0xf4, 0x68, 0x95, 0x73, 0x99, 0x40, 0x91,
  0xac, 0xc1, 0x4a, 0x99, 0x9e, 0xe6, 0xc1, 0xce, 0x8d, 0xfc, 0xd6, 0xb9,
  0xbc, 0xe3, 0x34, 0xe6, 0x08, 0x38, 0x7b, 0xd1, 0x7c, 0xeb, 0x18, 0xba,
  0x62, 0xc6, 0x25, 0x29, 0x55, 0x0b, 0x5b, 0x53, 0x65, 0x22, 0x8e, 0x41,
  0x65, 0xcd, 0xaa, 0xb2, 0x1b, 0x90, 0x11, 0xbe, 0x1d, 0x21, 0xc3, 0x25,
  0x55, 0x3a, 0x32, 0x2a, 0xea, 0x40, 0x3b, 0x08, 0xc8, 0x66, 0x9a, 0xc3,
  0x59, 0x9d, 0xf5, 0x0f, 0x47, 0x60, 0xd5, 0x8b, 0x47, 0x72, 0xa2, 0x04,
  0xfb, 0x25, 0x3c, 0x03, 0x5e, 0x86, 0x75, 0xa8, 0x82, 0x83, 0x45, 0xda,
  0x89, 0xc1, 0xaf, 0xbd, 0x0c, 0x00, 0xc2, 0xa6, 0x2c, 0x3f, 0x41, 0x82,
  0x23, 0xd2, 0x62, 0x3e, 0x02, 0xd0, 0xc5, 0x12, 0x71, 0x32, 0x84, 0xbb,
  0xfd, 0x58, 0x6a, 0xad, 0x1a, 0xba, 0x54, 0x22, 0xc3, 0x7a, 0x56, 0x35,
  0x98, 0x60, 0xf8, 0xcb, 0x76, 0x10, 0xa7, 0x1d, 0x22, 0x00, 0x05, 0x1c,
  0xd3, 0xaf, 0x2e, 0x11, 0xa4, 0x89, 0xc1, 0xb2, 0x4d, 0x5a, 0x25, 0xab,
  0xdd, 0x48, 0x50, 0xbc, 0x24, 0x0f, 0x4b, 0xb4, 0x45, 0xde, 0x82, 0x80,
  0xe5, 0x04, 0xe0, 0xd2, 0xb7, 0xa7, 0x87, 0x70, 0x26, 0x02, 0x4e, 0xf1,
  0xa4, 0x71, 0x4f, 0x0f, 0x68, 0x4e, 0x49, 0xfa, 0xab, 0x98, 0x17, 0xad,
  0x52, 0xef, 0x3f, 0xa7, 0x8d, 0x0a, 0x78, 0x48, 0x78, 0xbb, 0xf1, 0xfa,
  0x5a, 0xd0, 0x74, 0x74, 0xa4, 0x44, 0xd0, 0x7e, 0x73, 0xd0, 0xbd, 0x00,
  0x3e, 0x0f, 0x48, 0x1e, 0x5c, 0xac, 0x1d, 0x77, 0xe4, 0xec, 0x77, 0xa0,
  0x58, 0xf9, 0x02, 0x03, 0x01, 0x00, 0x01, 0xa3, 0x53, 0x30, 0x51, 0x30,
  0x1d, 0x06, 0x03, 0x55, 0x1d, 0x0e, 0x04, 0x16, 0x04, 0x14, 0xe2, 0x69,
  0xea, 0x21, 0xe2, 0xa6, 0x1e, 0xb2, 0x69, 0xe8, 0x7a, 0xed, 0x7d, 0x5d,
  0xc4, 0xc4, 0x0c, 0x87, 0x80, 0xf3, 0x30, 0x1f, 0x06, 0x03, 0x55, 0x1d,
  0x23, 0x04, 0x18, 0x30, 0x16, 0x80, 0x14, 0xe2, 0x69, 0xea, 0x21, 0xe2,
  0xa6, 0x1e, 0xb2, 0x69, 0xe8, 0x7a, 0xed, 0x7d, 0x5d, 0xc4, 0xc4, 0x0c,
  0x87, 0x80, 0xf3, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x1d, 0x13, 0x01, 0x01,
  0xff, 0x04, 0x05, 0x30, 0x03, 0x01, 0x01, 0xff, 0x30, 0x0d, 0x06, 0x09,
  0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x0b, 0x05, 0x00, 0x03,
  0x82, 0x01, 0x01, 0x00, 0x99, 0xed, 0x68, 0x8c, 0x9c, 0xa6, 0xca, 0x20,
  0x58, 0x35, 0xec, 0xf9, 0x95, 0x90, 0x56, 0x1e, 0x4d, 0x94, 0xb8, 0x63,
  0xff, 0x01, 0x89, 0xc5, 0x3f, 0x69, 0xff, 0x89, 0x9f, 0x7d, 0x78, 0x1a,
  0x0b, 0xe4, 0xf1, 0xc6, 0xcd, 0x0e, 0xfb, 0x20, 0x7c, 0x2c, 0x7a, 0x12,
  0x15, 0x1f, 0xb5, 0x16, 0x5b, 0x89, 0x6f, 0xe3, 0xf7, 0x03, 0x27, 0x25,
  0xca, 0x78, 0xc4, 0xae, 0xaa, 0xb7, 0xf2, 0xa8, 0xb1, 0xea, 0x1c, 0x7e,
  0x3f, 0xab, 0xc7, 0xd8, 0x4d, 0xd0, 0xc0, 0x51, 0xbd, 0x4e, 0x78, 0x93,
  0xb4, 0xef, 0xe4, 0x5a, 0x69, 0x8a, 0xc4, 0xa4, 0xd3, 0x66, 0x17, 0x0a,
  0x56, 0xbf, 0x79, 0x57, 0x0d, 0xfb, 0x69, 0xf5, 0xeb, 0xf9, 0x6b, 0x76,
  0x0f, 0xfe, 0xf3, 0xbc, 0x1c, 0x41, 0xda, 0xfa, 0x06, 0xcb, 0xc1, 0x8d,
  0x19, 0x71, 0x65, 0x54, 0xf8, 0x1c, 0x71, 0x4f, 0xa3, 0x05, 0xa3, 0x32,
  0x5b, 0x93, 0xf7, 0x94, 0x79, 0x0d, 0x09, 0xa3, 0xeb, 0xb6, 0xe8, 0xf4,
  0x5b, 0x6b, 0x04, 0x74, 0xe1, 0x1a, 0xcd, 0xe6, 0x44, 0xe2, 0x6f, 0x53,
  0x9e, 0xb0, 0xb0, 0x44, 0xe2, 0x5b, 0x29, 0x17, 0xfd, 0x75, 0xdc, 0xbe,
  0xe0, 0xf2, 0xd5, 0x16, 0x73, 0xfc, 0x30, 0x35, 0x74, 0x15, 0x34, 0x7a,
  0x69, 0xbc, 0xde, 0x7d, 0x4a, 0xa5, 0x09, 0x00, 0x7e, 0xff, 0xde, 0xcb,
  0x18, 0x06, 0x0b, 0x7e, 0x58, 0x5b, 0xf6, 0x34, 0xf5, 0x78, 0xfc, 0x89,
  0x00, 0x27, 0xf0, 0xc4, 0x6c, 0x06, 0xbc, 0x58, 0x09, 0x09, 0x0d, 0x75,
  0xee, 0x6b, 0xae, 0x5a, 0x86, 0x01, 0xe7, 0x9b, 0x0e, 0x0d, 0x53, 0x85,
  0x69, 0x89, 0x64, 0xa0, 0x04, 0x37, 0x09, 0xd8, 0xd5, 0x90, 0x2a, 0xf1,
  0x30, 0xd1, 0x92, 0xbd, 0x8d, 0x01, 0xaa, 0x24, 0x51, 0xa7, 0x29, 0x5b,
  0x6b, 0xda, 0xb7, 0xc1, 0x9d, 0x27, 0x11, 0x50, 0x31, 0x82, 0x02, 0x52,
  0x30, 0x82, 0x02, 0x4e, 0x02, 0x01, 0x01, 0x30, 0x42, 0x30, 0x2a, 0x31,
  0x14, 0x30, 0x12, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x0b, 0x52, 0x75,
  0x66, 0x75, 0x73, 0x54, 0x65, 0x73, 0x74, 0x43, 0x41, 0x31, 0x12, 0x30,
  0x10, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x09, 0x52, 0x75, 0x66, 0x75,
  0x73, 0x54, 0x65, 0x73, 0x74, 0x02, 0x14, 0x44, 0x7f, 0xab, 0xc2, 0xc7,
  0x6c, 0x31, 0x08, 0x11, 0x24, 0x89, 0xc3, 0xd2, 0x97, 0x63, 0xb3, 0xb2,
  0x74, 0x81, 0xc4, 0x30, 0x0b, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65,
  0x03, 0x04, 0x02, 0x01, 0xa0, 0x81, 0xe4, 0x30, 0x18, 0x06, 0x09, 0x2a,
  0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09, 0x03, 0x31, 0x0b, 0x06, 0x09,
  0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0x30, 0x1c, 0x06,
  0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09, 0x05, 0x31, 0x0f,
  0x17, 0x0d, 0x32, 0x36, 0x30, 0x33, 0x30, 0x32, 0x30, 0x31, 0x34, 0x31,
  0x32, 0x37, 0x5a, 0x30, 0x2f, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7,
  0x0d, 0x01, 0x09, 0x04, 0x31, 0x22, 0x04, 0x20, 0xb5, 0xa2, 0xc9, 0x62,
  0x50, 0x61, 0x23, 0x66, 0xea, 0x27, 0x2f, 0xfa, 0xc6, 0xd9, 0x74, 0x4a,
  0xaf, 0x4b, 0x45, 0xaa, 0xcd, 0x96, 0xaa, 0x7c, 0xfc, 0xb9, 0x31, 0xee,
  0x3b, 0x55, 0x82, 0x59, 0x30, 0x79, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86,
  0xf7, 0x0d, 0x01, 0x09, 0x0f, 0x31, 0x6c, 0x30, 0x6a, 0x30, 0x0b, 0x06,
  0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x01, 0x2a, 0x30, 0x0b,
  0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x01, 0x16, 0x30,
  0x0b, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x01, 0x02,
  0x30, 0x0a, 0x06, 0x08, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x03, 0x07,
  0x30, 0x0e, 0x06, 0x08, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x03, 0x02,
  0x02, 0x02, 0x00, 0x80, 0x30, 0x0d, 0x06, 0x08, 0x2a, 0x86, 0x48, 0x86,
  0xf7, 0x0d, 0x03, 0x02, 0x02, 0x01, 0x40, 0x30, 0x07, 0x06, 0x05, 0x2b,
  0x0e, 0x03, 0x02, 0x07, 0x30, 0x0d, 0x06, 0x08, 0x2a, 0x86, 0x48, 0x86,
  0xf7, 0x0d, 0x03, 0x02, 0x02, 0x01, 0x28, 0x30, 0x0d, 0x06, 0x09, 0x2a,
  0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82,
  0x01, 0x00, 0xe1, 0xc1, 0x04, 0x12, 0xc2, 0xe5, 0x97, 0x3d, 0xc5, 0xba,
  0x1f, 0xbc, 0xb2, 0xa3, 0x3e, 0x3a, 0xd5, 0x95, 0x0c, 0x7b, 0xc8, 0x39,
  0xd6, 0x16, 0x26, 0x30, 0x87, 0x1e, 0x14, 0x39, 0x51, 0x90, 0xbf, 0x85,
  0x99, 0x3a, 0x50, 0x57, 0x2e, 0x33, 0x1e, 0xac, 0xb1, 0x18, 0xd0, 0xb9,
  0xe5, 0xd9, 0xd5, 0xd1, 0xfe, 0xb0, 0xdf, 0x54, 0xbd, 0x3c, 0x25, 0xb8,
  0x4b, 0x35, 0x07, 0xba, 0x7b, 0x24, 0x13, 0x6c, 0x63, 0x19, 0x67, 0xd9,
  0x35, 0x40, 0x7c, 0x1e, 0xc8, 0x6f, 0x4e, 0x9e, 0x88, 0x19, 0x4f, 0xfb,
  0xc0, 0x46, 0x37, 0x17, 0x10, 0xab, 0x1b, 0x0c, 0x8b, 0xb2, 0xa6, 0xe0,
  0x37, 0x47, 0xfe, 0x5f, 0xf1, 0x45, 0xdc, 0x65, 0xdc, 0x6d, 0x90, 0x15,
  0x7e, 0x9c, 0xee, 0x64, 0x24, 0x6e, 0x7a, 0x22, 0xc3, 0xe3, 0x7e, 0xaa,
  0xab, 0xa8, 0x1b, 0x1b, 0x88, 0x89, 0x89, 0x9b, 0x81, 0x0b, 0x1f, 0x42,
  0x48, 0x22, 0x30, 0x10, 0x1d, 0x3c, 0xee, 0xc1, 0x5e, 0x93, 0x76, 0xf8,
  0x56, 0x8d, 0xc5, 0x2e, 0x8f, 0xa1, 0x76, 0xe9, 0x42, 0x1a, 0x43, 0x9a,
  0x27, 0x9c, 0x19, 0x88, 0x63, 0x44, 0x04, 0xc8, 0x8d, 0x31, 0x5b, 0x42,
  0x57, 0xc0, 0x3d, 0x6f, 0x15, 0x83, 0x8b, 0xe7, 0x99, 0x1e, 0x02, 0x6c,
  0x56, 0xaa, 0xaf, 0x62, 0x2d, 0x0b, 0x16, 0x7c, 0xfd, 0xec, 0xa2, 0x11,
  0xda, 0x35, 0x08, 0xc7, 0x44, 0xd4, 0x20, 0x39, 0x06, 0x89, 0x77, 0xf7,
  0x61, 0xfc, 0xe7, 0x24, 0x68, 0xb2, 0x31, 0x91, 0x53, 0xb8, 0x06, 0xdc,
  0x49, 0x70, 0xce, 0x0c, 0xdf, 0x97, 0x25, 0x85, 0xef, 0xd5, 0xf3, 0x5c,
  0x67, 0x8e, 0xa5, 0x86, 0xf0, 0x49, 0xc7, 0x7f, 0xa6, 0x05, 0x3c, 0x48,
  0x79, 0xc7, 0x94, 0x69, 0x78, 0x72, 0x71, 0x21, 0xbe, 0xf1, 0x11, 0x8f,
  0xfd, 0x03, 0x80, 0x4f, 0x75, 0x0f
};
static const uint32_t chain_signed_p7_len = 2298;

/* self_signed.p7 DER — SelfSigned cert (self-signed, chain of 1) */
static const uint8_t self_signed_p7[] = {
  0x30, 0x82, 0x05, 0xcb, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
  0x01, 0x07, 0x02, 0xa0, 0x82, 0x05, 0xbc, 0x30, 0x82, 0x05, 0xb8, 0x02,
  0x01, 0x01, 0x31, 0x0d, 0x30, 0x0b, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
  0x65, 0x03, 0x04, 0x02, 0x01, 0x30, 0x14, 0x06, 0x09, 0x2a, 0x86, 0x48,
  0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x07, 0x04, 0x05, 0x64, 0x75,
  0x6d, 0x6d, 0x79, 0xa0, 0x82, 0x03, 0x37, 0x30, 0x82, 0x03, 0x33, 0x30,
  0x82, 0x02, 0x1b, 0xa0, 0x03, 0x02, 0x01, 0x02, 0x02, 0x14, 0x0c, 0xb8,
  0x9c, 0xda, 0x94, 0xb7, 0x43, 0x14, 0x85, 0xb0, 0x22, 0x6d, 0x63, 0x82,
  0xb8, 0x66, 0xec, 0x05, 0xfa, 0x58, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
  0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x0b, 0x05, 0x00, 0x30, 0x29, 0x31,
  0x13, 0x30, 0x11, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x0a, 0x53, 0x65,
  0x6c, 0x66, 0x53, 0x69, 0x67, 0x6e, 0x65, 0x64, 0x31, 0x12, 0x30, 0x10,
  0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x09, 0x52, 0x75, 0x66, 0x75, 0x73,
  0x54, 0x65, 0x73, 0x74, 0x30, 0x1e, 0x17, 0x0d, 0x32, 0x36, 0x30, 0x33,
  0x30, 0x32, 0x30, 0x31, 0x34, 0x31, 0x32, 0x37, 0x5a, 0x17, 0x0d, 0x33,
  0x36, 0x30, 0x32, 0x32, 0x38, 0x30, 0x31, 0x34, 0x31, 0x32, 0x37, 0x5a,
  0x30, 0x29, 0x31, 0x13, 0x30, 0x11, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c,
  0x0a, 0x53, 0x65, 0x6c, 0x66, 0x53, 0x69, 0x67, 0x6e, 0x65, 0x64, 0x31,
  0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x09, 0x52, 0x75,
  0x66, 0x75, 0x73, 0x54, 0x65, 0x73, 0x74, 0x30, 0x82, 0x01, 0x22, 0x30,
  0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01,
  0x05, 0x00, 0x03, 0x82, 0x01, 0x0f, 0x00, 0x30, 0x82, 0x01, 0x0a, 0x02,
  0x82, 0x01, 0x01, 0x00, 0xd4, 0xb4, 0xf5, 0x6c, 0xca, 0x8b, 0x88, 0x59,
  0xa3, 0xfd, 0x30, 0xcc, 0x7d, 0x62, 0xfb, 0xed, 0xbc, 0x15, 0x64, 0x8b,
  0xa7, 0xcf, 0x55, 0x3f, 0xf5, 0xf4, 0x19, 0x59, 0x6c, 0x30, 0xb8, 0x0c,
  0x5b, 0x93, 0xf1, 0x40, 0xdf, 0xd8, 0x44, 0xd1, 0x88, 0x39, 0x0e, 0xcf,
  0xa7, 0xf1, 0x90, 0x65, 0x58, 0x55, 0x90, 0xe8, 0xbe, 0x10, 0x58, 0x95,
  0xf7, 0x19, 0xd3, 0x3a, 0x16, 0x9f, 0x06, 0x5d, 0xeb, 0x6a, 0x9e, 0x3e,
  0xd0, 0x4a, 0xc1, 0x42, 0x7c, 0xc1, 0xf8, 0x26, 0x25, 0xf7, 0x35, 0x86,
  0x10, 0xca, 0x9a, 0xb0, 0xa8, 0x49, 0xef, 0xcc, 0xc5, 0x47, 0x01, 0xaf,
  0xfc, 0x15, 0x61, 0x9d, 0x82, 0xbd, 0x79, 0xe4, 0x0a, 0x00, 0x68, 0xec,
  0xd9, 0x46, 0x66, 0x3b, 0x3e, 0xde, 0x95, 0x71, 0xe8, 0x51, 0xee, 0x45,
  0x06, 0x6f, 0x44, 0x8d, 0xe2, 0x60, 0xbc, 0x63, 0x5e, 0x3c, 0x5f, 0xb6,
  0xac, 0xf1, 0x58, 0x48, 0x9e, 0x96, 0x89, 0xc5, 0x5c, 0x86, 0xec, 0x78,
  0x39, 0x6e, 0x93, 0xf2, 0xb3, 0x88, 0x1c, 0x59, 0xba, 0xf1, 0xd5, 0x98,
  0x8f, 0xb2, 0x7a, 0x4e, 0x05, 0x45, 0x99, 0x92, 0x2c, 0x0a, 0xc4, 0x0c,
  0x72, 0xf4, 0x56, 0xf6, 0x1b, 0xeb, 0xa6, 0xd0, 0x6c, 0x8a, 0x83, 0xa8,
  0x96, 0xa8, 0x56, 0xfc, 0x39, 0x83, 0xe0, 0xb9, 0xbe, 0xec, 0xd6, 0x9b,
  0x64, 0x69, 0x1d, 0x3c, 0x09, 0x06, 0x55, 0x8d, 0x9e, 0x25, 0xc0, 0xda,
  0xa2, 0xbc, 0x66, 0x3d, 0x86, 0xa6, 0x50, 0x68, 0x86, 0x84, 0xf5, 0x34,
  0xfa, 0xc8, 0xaf, 0xbb, 0xad, 0xfd, 0x27, 0xc5, 0x3f, 0x51, 0xe4, 0x52,
  0xbc, 0x82, 0x3b, 0xde, 0xce, 0xb1, 0x16, 0x5a, 0xca, 0x7c, 0x1a, 0x1e,
  0x91, 0xe9, 0xd5, 0xdd, 0xa6, 0x6d, 0xaa, 0x8b, 0xa7, 0x4a, 0xa8, 0xd1,
  0xc6, 0x80, 0xb0, 0x87, 0x87, 0x60, 0x25, 0x29, 0x02, 0x03, 0x01, 0x00,
  0x01, 0xa3, 0x53, 0x30, 0x51, 0x30, 0x1d, 0x06, 0x03, 0x55, 0x1d, 0x0e,
  0x04, 0x16, 0x04, 0x14, 0x2c, 0xc3, 0x3f, 0xd1, 0x8c, 0xd6, 0xd8, 0x50,
  0xfd, 0x2a, 0xcd, 0x6c, 0xd8, 0xe7, 0x35, 0xe8, 0xad, 0x8e, 0x90, 0x50,
  0x30, 0x1f, 0x06, 0x03, 0x55, 0x1d, 0x23, 0x04, 0x18, 0x30, 0x16, 0x80,
  0x14, 0x2c, 0xc3, 0x3f, 0xd1, 0x8c, 0xd6, 0xd8, 0x50, 0xfd, 0x2a, 0xcd,
  0x6c, 0xd8, 0xe7, 0x35, 0xe8, 0xad, 0x8e, 0x90, 0x50, 0x30, 0x0f, 0x06,
  0x03, 0x55, 0x1d, 0x13, 0x01, 0x01, 0xff, 0x04, 0x05, 0x30, 0x03, 0x01,
  0x01, 0xff, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
  0x01, 0x01, 0x0b, 0x05, 0x00, 0x03, 0x82, 0x01, 0x01, 0x00, 0x1f, 0x73,
  0xe3, 0x91, 0x59, 0x75, 0x36, 0x5e, 0xd0, 0xfc, 0x2e, 0x7b, 0x95, 0x5d,
  0xdf, 0x60, 0x49, 0x74, 0xdc, 0x56, 0x39, 0xe6, 0x2b, 0x3b, 0x24, 0xf9,
  0xd1, 0x0d, 0xe9, 0x48, 0xf2, 0xfa, 0x99, 0xfe, 0x97, 0x38, 0x11, 0x58,
  0xe8, 0x89, 0xe8, 0xa8, 0x31, 0x08, 0xa4, 0x46, 0x13, 0xa9, 0xc0, 0xc3,
  0xe1, 0xf3, 0xf2, 0xa4, 0xe3, 0x44, 0x22, 0x78, 0x6a, 0x2b, 0x33, 0x93,
  0x5d, 0xe6, 0xd5, 0xa2, 0x47, 0x7c, 0x80, 0x87, 0x55, 0xf8, 0x93, 0x12,
  0x80, 0x4c, 0xc7, 0x0b, 0xae, 0x2b, 0x3b, 0x6f, 0x09, 0xaf, 0xaa, 0xd0,
  0x0a, 0x87, 0xeb, 0x83, 0xa7, 0x28, 0xba, 0x0d, 0x80, 0xe5, 0x14, 0x5b,
  0x71, 0x7c, 0x07, 0xf0, 0x0d, 0x2a, 0x32, 0x54, 0x0b, 0xa2, 0xde, 0x1d,
  0x31, 0x5f, 0x6e, 0x5c, 0x57, 0x05, 0x3b, 0x25, 0xd5, 0x6a, 0xea, 0xe3,
  0x9a, 0xca, 0xbb, 0x13, 0xfc, 0x87, 0xc6, 0x55, 0x2f, 0xca, 0x6c, 0xb2,
  0x28, 0x19, 0xc7, 0xef, 0x4b, 0x1f, 0x09, 0xd9, 0x69, 0xfd, 0xde, 0xd4,
  0x80, 0x67, 0x52, 0xdb, 0xa2, 0xad, 0x09, 0xa1, 0x8c, 0x5a, 0x61, 0xd0,
  0x59, 0x9f, 0xa0, 0xe8, 0x5d, 0xa0, 0x21, 0xaa, 0x1d, 0x3c, 0x7b, 0x5f,
  0x66, 0x5e, 0x76, 0xb9, 0x7e, 0x01, 0x65, 0x1a, 0xe3, 0x6e, 0x84, 0xcd,
  0x36, 0x7d, 0xe9, 0x82, 0x90, 0xec, 0x27, 0x87, 0x4d, 0x6b, 0x9f, 0x4f,
  0x7a, 0x21, 0xd9, 0x2d, 0x11, 0x61, 0xf8, 0x92, 0x7b, 0xd5, 0xc3, 0xbc,
  0x0f, 0xcc, 0xc7, 0x0d, 0x1f, 0xf6, 0x22, 0x04, 0x50, 0xfc, 0x59, 0xaf,
  0xf7, 0x92, 0x5c, 0xa1, 0xc1, 0xe4, 0x07, 0xa4, 0xf7, 0x35, 0x95, 0x5c,
  0x46, 0x4f, 0xe8, 0xad, 0xb7, 0x63, 0xb5, 0x5d, 0xd6, 0xe4, 0xe5, 0x4d,
  0x20, 0xc3, 0xa7, 0x9a, 0x03, 0x0c, 0x34, 0x6d, 0x13, 0x4e, 0x15, 0x21,
  0x5e, 0x30, 0x31, 0x82, 0x02, 0x51, 0x30, 0x82, 0x02, 0x4d, 0x02, 0x01,
  0x01, 0x30, 0x41, 0x30, 0x29, 0x31, 0x13, 0x30, 0x11, 0x06, 0x03, 0x55,
  0x04, 0x03, 0x0c, 0x0a, 0x53, 0x65, 0x6c, 0x66, 0x53, 0x69, 0x67, 0x6e,
  0x65, 0x64, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c,
  0x09, 0x52, 0x75, 0x66, 0x75, 0x73, 0x54, 0x65, 0x73, 0x74, 0x02, 0x14,
  0x0c, 0xb8, 0x9c, 0xda, 0x94, 0xb7, 0x43, 0x14, 0x85, 0xb0, 0x22, 0x6d,
  0x63, 0x82, 0xb8, 0x66, 0xec, 0x05, 0xfa, 0x58, 0x30, 0x0b, 0x06, 0x09,
  0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0xa0, 0x81, 0xe4,
  0x30, 0x18, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09,
  0x03, 0x31, 0x0b, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
  0x07, 0x01, 0x30, 0x1c, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
  0x01, 0x09, 0x05, 0x31, 0x0f, 0x17, 0x0d, 0x32, 0x36, 0x30, 0x33, 0x30,
  0x32, 0x30, 0x31, 0x34, 0x31, 0x32, 0x37, 0x5a, 0x30, 0x2f, 0x06, 0x09,
  0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09, 0x04, 0x31, 0x22, 0x04,
  0x20, 0xb5, 0xa2, 0xc9, 0x62, 0x50, 0x61, 0x23, 0x66, 0xea, 0x27, 0x2f,
  0xfa, 0xc6, 0xd9, 0x74, 0x4a, 0xaf, 0x4b, 0x45, 0xaa, 0xcd, 0x96, 0xaa,
  0x7c, 0xfc, 0xb9, 0x31, 0xee, 0x3b, 0x55, 0x82, 0x59, 0x30, 0x79, 0x06,
  0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09, 0x0f, 0x31, 0x6c,
  0x30, 0x6a, 0x30, 0x0b, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03,
  0x04, 0x01, 0x2a, 0x30, 0x0b, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65,
  0x03, 0x04, 0x01, 0x16, 0x30, 0x0b, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
  0x65, 0x03, 0x04, 0x01, 0x02, 0x30, 0x0a, 0x06, 0x08, 0x2a, 0x86, 0x48,
  0x86, 0xf7, 0x0d, 0x03, 0x07, 0x30, 0x0e, 0x06, 0x08, 0x2a, 0x86, 0x48,
  0x86, 0xf7, 0x0d, 0x03, 0x02, 0x02, 0x02, 0x00, 0x80, 0x30, 0x0d, 0x06,
  0x08, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x03, 0x02, 0x02, 0x01, 0x40,
  0x30, 0x07, 0x06, 0x05, 0x2b, 0x0e, 0x03, 0x02, 0x07, 0x30, 0x0d, 0x06,
  0x08, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x03, 0x02, 0x02, 0x01, 0x28,
  0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01,
  0x01, 0x05, 0x00, 0x04, 0x82, 0x01, 0x00, 0x0c, 0xa7, 0xab, 0x51, 0x8b,
  0x89, 0x31, 0xdf, 0x76, 0xa1, 0x97, 0xa3, 0x93, 0xbf, 0xab, 0x7c, 0xee,
  0x31, 0x93, 0x58, 0x44, 0xc6, 0xfd, 0xff, 0x18, 0x3d, 0xa1, 0xba, 0xba,
  0xc0, 0xba, 0x92, 0xcf, 0x1e, 0x24, 0x90, 0x90, 0xac, 0x43, 0x57, 0x0d,
  0x20, 0x2e, 0x65, 0x47, 0xa7, 0xa3, 0x72, 0x51, 0x5a, 0x7a, 0x72, 0x20,
  0xe8, 0xfd, 0x83, 0xf0, 0x5d, 0xb7, 0x2e, 0xb8, 0x5a, 0xcf, 0xe9, 0x8f,
  0x9e, 0xc8, 0x98, 0x5a, 0x61, 0xd7, 0xb6, 0xca, 0x5f, 0x90, 0xc8, 0xa3,
  0x32, 0x37, 0x91, 0xb1, 0x69, 0x93, 0x36, 0x77, 0x83, 0x28, 0xde, 0xb8,
  0x35, 0xe2, 0x6c, 0x1c, 0xc3, 0x7c, 0x98, 0xae, 0xa8, 0x7c, 0xb3, 0x85,
  0x1a, 0x5e, 0xbd, 0x96, 0xaf, 0x43, 0xe7, 0x5d, 0x74, 0xec, 0x0d, 0x14,
  0xdf, 0x30, 0x49, 0x91, 0x42, 0x04, 0xf2, 0x1a, 0x2f, 0xbc, 0x6d, 0xcf,
  0x9a, 0x04, 0x4b, 0xe2, 0xe8, 0x15, 0x04, 0x9e, 0x90, 0x68, 0x71, 0x8a,
  0x68, 0x99, 0xb2, 0x83, 0xf3, 0xd5, 0xc1, 0xa8, 0x87, 0x11, 0x1a, 0x0a,
  0x77, 0x62, 0x88, 0x2e, 0xfa, 0x7c, 0x42, 0x59, 0xf1, 0xf9, 0xfc, 0xa1,
  0x09, 0x0f, 0x3f, 0x2e, 0x69, 0xbf, 0x2e, 0x7f, 0x96, 0xe1, 0x2a, 0x13,
  0x1c, 0xdf, 0x45, 0x55, 0xab, 0xf5, 0x77, 0x94, 0xd2, 0x47, 0x0f, 0x60,
  0x63, 0x5d, 0xc2, 0x7f, 0x46, 0x3b, 0xae, 0x54, 0x27, 0x71, 0x7e, 0x26,
  0xe3, 0x7d, 0xb7, 0x6d, 0xec, 0xfb, 0x4b, 0x43, 0xda, 0x4a, 0x7e, 0x4b,
  0xcd, 0xb1, 0x2a, 0x17, 0xc7, 0xf2, 0x66, 0xb1, 0x12, 0x90, 0x9c, 0x76,
  0xda, 0x1e, 0x7c, 0x35, 0x3a, 0x8b, 0x31, 0x80, 0x79, 0xf1, 0xc6, 0xe0,
  0xb3, 0xd2, 0x1b, 0x56, 0xc5, 0xf2, 0x28, 0xb2, 0x68, 0x26, 0xd6, 0xa3,
  0x67, 0xdf, 0xc1, 0xad, 0x02, 0x60, 0x50, 0xe1, 0x0d, 0x86, 0x61
};
static const uint32_t self_signed_p7_len = 1487;

/* RufusTestCA in PEM format (trust anchor for tests) */
static const char test_ca_pem[] =
    "-----BEGIN CERTIFICATE-----\n"
    "MIIDNTCCAh2gAwIBAgIUECN2LLZTECIpiQ2kFYTHcmbzt2wwDQYJKoZIhvcNAQEL\n"
    "BQAwKjEUMBIGA1UEAwwLUnVmdXNUZXN0Q0ExEjAQBgNVBAoMCVJ1ZnVzVGVzdDAe\n"
    "Fw0yNjAzMDIwMTQxMjdaFw0zNjAyMjgwMTQxMjdaMCoxFDASBgNVBAMMC1J1ZnVz\n"
    "VGVzdENBMRIwEAYDVQQKDAlSdWZ1c1Rlc3QwggEiMA0GCSqGSIb3DQEBAQUAA4IB\n"
    "DwAwggEKAoIBAQC9+e/0u2nSnkCkc0JfKVbvgvhWAUF6KjTM2682xUOR9GiVc5lA\n"
    "kazBSpme5sHOjfzWubzjNOYIOHvRfOsYumLGJSlVC1tTZSKOQWXNqrIbkBG+HSHD\n"
    "JVU6MirqQDsIyGaaw1md9Q9HYNWLR3KiBPslPANehnWogoNF2onBr70MAMKmLD9B\n"
    "giPSYj4C0MUScTKEu/1Yaq0aulQiw3pWNZhg+Mt2EKcdIgAFHNOvLhGkicGyTVol\n"
    "q91IULwkD0u0Rd6CgOUE4NK3p4dwJgJO8aRxTw9oTkn6q5gXrVLvP6eNCnhIeLvx\n"
    "+lrQdHSkRNB+c9C9AD4PSB5crB135Ox3oFj5AgMBAAGjUzBRMB0GA1UdDgQWBBTi\n"
    "aeoh4qYesmnoeu19XcTEDIeA8zAfBgNVHSMEGDAWgBTiaeoh4qYesmnoeu19XcTE\n"
    "DIeA8zAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQCZ7WiMnKbK\n"
    "IFg17PmVkFYeTZS4Y/8BicU/af+Jn314Ggvk8cbNDvsgfCx6EhUftRZbiW/j9wMn\n"
    "Jcp4xK6qt/Koseocfj+rx9hN0MBRvU54k7Tv5FppisSk02YXCla/eVcN+2n16/lr\n"
    "dg/+87wcQdr6BsvBjRlxZVT4HHFPowWjMluT95R5DQmj67bo9FtrBHThGs3mROJv\n"
    "U56wsETiWykX/XXcvuDy1RZz/DA1dBU0emm83n1KpQkAfv/eyxgGC35YW/Y09Xj8\n"
    "iQAn8MRsBrxYCQkNde5rrlqGAeebDg1ThWmJZKAENwnY1ZAq8TDRkr2NAaokUacp\n"
    "W2vat8GdJxFQ\n"
    "-----END CERTIFICATE-----\n";

/* ================================================================
 * Tests: GetIssuerCertificateInfo — chain_trusted field
 * ================================================================ */

TEST(get_issuer_cert_info_chain_trusted_false_for_null_cert)
{
    cert_info_t info;
    memset(&info, 0xff, sizeof(info));   /* poison */
    pki_set_ca_bundle_path(NULL);        /* use system default */
    GetIssuerCertificateInfo(NULL, &info);
    CHECK_MSG(info.chain_trusted == FALSE, "chain_trusted must be FALSE for NULL cert");
}

TEST(get_issuer_cert_info_chain_trusted_false_for_zero_cert)
{
    cert_info_t info;
    uint8_t zero[16] = {0};
    memset(&info, 0xff, sizeof(info));
    pki_set_ca_bundle_path(NULL);
    GetIssuerCertificateInfo(zero, &info);
    CHECK_MSG(info.chain_trusted == FALSE, "chain_trusted must be FALSE for zero-length cert");
}

TEST(get_issuer_cert_info_chain_signed_trusted_with_test_ca)
{
    /* chain_signed.p7: RufusSigner signed by RufusTestCA; with test CA → trusted */
    char *ca_path = write_temp_pem(test_ca_pem);
    pki_set_ca_bundle_path(ca_path);
    uint8_t *wc = make_win_cert(chain_signed_p7, chain_signed_p7_len);
    cert_info_t info;
    memset(&info, 0, sizeof(info));
    int r = GetIssuerCertificateInfo(wc, &info);
    free(wc);
    pki_set_ca_bundle_path(NULL);
    if (ca_path) { unlink(ca_path); free(ca_path); }
    CHECK_MSG(r == 2, "chain_signed should return 2 (has issuer)");
    CHECK_MSG(info.chain_trusted == TRUE,
              "chain_signed.p7 with test CA should be trusted");
}

TEST(get_issuer_cert_info_chain_signed_not_trusted_system_ca)
{
    /* chain_signed.p7 is NOT trusted by the system CA (RufusTestCA is self-signed) */
    pki_set_ca_bundle_path(NULL);  /* use real system CA */
    uint8_t *wc = make_win_cert(chain_signed_p7, chain_signed_p7_len);
    cert_info_t info;
    memset(&info, 0, sizeof(info));
    GetIssuerCertificateInfo(wc, &info);
    free(wc);
    CHECK_MSG(info.chain_trusted == FALSE,
              "chain_signed.p7 should NOT be trusted by system CA");
}

TEST(get_issuer_cert_info_chain_signed_not_trusted_no_ca_file)
{
    /* Pointing to a nonexistent CA file → chain_trusted = FALSE */
    pki_set_ca_bundle_path("/nonexistent_ca_file_rufus_test.pem");
    uint8_t *wc = make_win_cert(chain_signed_p7, chain_signed_p7_len);
    cert_info_t info;
    memset(&info, 0, sizeof(info));
    GetIssuerCertificateInfo(wc, &info);
    free(wc);
    pki_set_ca_bundle_path(NULL);
    CHECK_MSG(info.chain_trusted == FALSE,
              "chain_trusted must be FALSE when CA file does not exist");
}

TEST(get_issuer_cert_info_self_signed_not_trusted_with_test_ca)
{
    /* self_signed.p7: SelfSigned not signed by RufusTestCA → not trusted */
    char *ca_path = write_temp_pem(test_ca_pem);
    pki_set_ca_bundle_path(ca_path);
    uint8_t *wc = make_win_cert(self_signed_p7, self_signed_p7_len);
    cert_info_t info;
    memset(&info, 0, sizeof(info));
    int r = GetIssuerCertificateInfo(wc, &info);
    free(wc);
    pki_set_ca_bundle_path(NULL);
    if (ca_path) { unlink(ca_path); free(ca_path); }
    CHECK_MSG(r == 1, "self_signed should return 1 (no issuer)");
    CHECK_MSG(info.chain_trusted == FALSE,
              "self_signed.p7 should NOT be trusted even with test CA");
}

TEST(get_issuer_cert_info_name_correct_chain_signed)
{
    /* chain_signed: issuer (cert[1]) is RufusTestCA */
    pki_set_ca_bundle_path(NULL);
    uint8_t *wc = make_win_cert(chain_signed_p7, chain_signed_p7_len);
    cert_info_t info;
    memset(&info, 0, sizeof(info));
    int r = GetIssuerCertificateInfo(wc, &info);
    free(wc);
    CHECK_MSG(r == 2, "chain_signed should return 2");
    CHECK_MSG(strcmp(info.name, "RufusTestCA") == 0,
              "issuer name should be RufusTestCA");
}

TEST(get_issuer_cert_info_name_correct_self_signed)
{
    /* self_signed: only cert is SelfSigned */
    pki_set_ca_bundle_path(NULL);
    uint8_t *wc = make_win_cert(self_signed_p7, self_signed_p7_len);
    cert_info_t info;
    memset(&info, 0, sizeof(info));
    int r = GetIssuerCertificateInfo(wc, &info);
    free(wc);
    CHECK_MSG(r == 1, "self_signed should return 1");
    CHECK_MSG(strcmp(info.name, "SelfSigned") == 0,
              "signer name should be SelfSigned");
}

TEST(get_issuer_cert_info_thumbprint_nonzero_chain_signed)
{
    /* thumbprint should be populated for a valid cert */
    pki_set_ca_bundle_path(NULL);
    uint8_t *wc = make_win_cert(chain_signed_p7, chain_signed_p7_len);
    cert_info_t info;
    memset(&info, 0, sizeof(info));
    GetIssuerCertificateInfo(wc, &info);
    free(wc);
    int all_zero = 1;
    for (int i = 0; i < SHA1_HASHSIZE; i++)
        if (info.thumbprint[i]) { all_zero = 0; break; }
    CHECK_MSG(!all_zero, "thumbprint should be non-zero for valid cert");
}

/* ================================================================
 * Tests: GetSignatureCertInfo
 * ================================================================ */

TEST(get_signature_cert_info_null_path)
{
    cert_info_t info;
    memset(&info, 0, sizeof(info));
    int r = GetSignatureCertInfo(NULL, &info);
    CHECK_MSG(r < 0 || r == 0, "NULL path should return <= 0");
}

TEST(get_signature_cert_info_null_info)
{
    int r = GetSignatureCertInfo("/some/path", NULL);
    CHECK_MSG(r < 0 || r == 0, "NULL info should return <= 0");
}

TEST(get_signature_cert_info_nonexistent_path)
{
    cert_info_t info;
    memset(&info, 0, sizeof(info));
    int r = GetSignatureCertInfo("/nonexistent_rufus_test_file.exe", &info);
    CHECK_MSG(r <= 0, "nonexistent path should return <= 0");
    CHECK_MSG(info.chain_trusted == FALSE,
              "chain_trusted should be FALSE for nonexistent file");
}



TEST(validate_signature_nonexistent)
{
    /* On Linux, a nonexistent file should return non-zero (file not found) */
    LONG r = ValidateSignature(NULL, "/nonexistent_file_for_rufus_test.exe");
    CHECK_MSG(r != 0, "nonexistent file should return error (non-zero)");
}

TEST(validate_signature_null_path)
{
    /* NULL path is a no-op stub on Linux — should not crash */
    LONG r = ValidateSignature(NULL, NULL);
    (void)r;
    CHECK(1);
}

/* ================================================================
 * Tests: ParseSKUSiPolicy
 * ================================================================ */

TEST(parse_sku_si_policy_no_crash)
{
    /* Windows-only feature — must return FALSE on Linux */
    BOOL r = ParseSKUSiPolicy();
    CHECK_MSG(r == FALSE, "ParseSKUSiPolicy should return FALSE on Linux");
}

/* ================================================================
 * Main
 * ================================================================ */
int main(void)
{
    printf("=== PKI Linux Tests ===\n");

    RUN_TEST(win_pki_error_string_not_null);
    RUN_TEST(win_pki_error_string_no_error);

    RUN_TEST(validate_openssl_sig_null_buf);
    RUN_TEST(validate_openssl_sig_null_sig);
    RUN_TEST(validate_openssl_sig_zero_len);
    RUN_TEST(validate_openssl_sig_wrong_sig_size);
    RUN_TEST(validate_openssl_sig_bad_signature);

    RUN_TEST(get_signature_name_null_path_ok);
    RUN_TEST(get_signature_name_nonexistent);
    RUN_TEST(get_signature_name_not_pe);

    RUN_TEST(get_signature_timestamp_null);
    RUN_TEST(get_signature_timestamp_nonexistent);
    RUN_TEST(get_signature_timestamp_not_pe);

    RUN_TEST(get_issuer_cert_info_null_cert);
    RUN_TEST(get_issuer_cert_info_null_info);
    RUN_TEST(get_issuer_cert_info_zero_length);

    RUN_TEST(get_issuer_cert_info_chain_trusted_false_for_null_cert);
    RUN_TEST(get_issuer_cert_info_chain_trusted_false_for_zero_cert);
    RUN_TEST(get_issuer_cert_info_chain_signed_trusted_with_test_ca);
    RUN_TEST(get_issuer_cert_info_chain_signed_not_trusted_system_ca);
    RUN_TEST(get_issuer_cert_info_chain_signed_not_trusted_no_ca_file);
    RUN_TEST(get_issuer_cert_info_self_signed_not_trusted_with_test_ca);
    RUN_TEST(get_issuer_cert_info_name_correct_chain_signed);
    RUN_TEST(get_issuer_cert_info_name_correct_self_signed);
    RUN_TEST(get_issuer_cert_info_thumbprint_nonzero_chain_signed);

    RUN_TEST(get_signature_cert_info_null_path);
    RUN_TEST(get_signature_cert_info_null_info);
    RUN_TEST(get_signature_cert_info_nonexistent_path);

    RUN_TEST(validate_signature_nonexistent);
    RUN_TEST(validate_signature_null_path);

    RUN_TEST(parse_sku_si_policy_no_crash);

    PRINT_RESULTS();
    return g_failed > 0 ? 1 : 0;
}

#endif /* __linux__ */
